<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>11</title>
	<script src="./js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<div id="game"></div>
<script type="text/javascript">

const width = window.innerWidth;
const height = window.innerHeight;

var game = new Phaser.Game(width, height, Phaser.AUTO, '#game');

const progressFn = (game) => {
    let progressText = game.add.text(game.world.centerX, game.world.centerY, '0%', {
        fontSize: '60px',
        fill: '#fff',
    });
    let deadLine = false;
    setTimeout(() => {
        deadLine = true;
    }, 3000);
    progressText.anchor.setTo(0.5, 0.5);
    const loadComplete = function() {
        if (deadLine) {
            game.state.start('created');
        } else {
            setTimeout(loadComplete, 1000);
        }
    };

    const loading = (progress) => {
        progressText.text = progress + '%';
    };

    game.load.onFileComplete.add(loading);
    game.load.onLoadComplete.add(loadComplete);
}

const states = {
    preload: function() {
        this.preload = function() {
			game.stage.backgroundColor = '#000';
            game.load.crossOrigin = 'anonymous'; // è®¾ç½®è·¨åŸŸ
            game.load.image('bg', './img/bg.png');
            game.load.image('dude', './img/dude.png');
            game.load.image('green', './img/green.png');
            game.load.image('red', './img/red.png');
            game.load.image('yellow', './img/yellow.png');
            game.load.image('bomb', './img/bomb.png');
            game.load.image('five', './img/five.png');
            game.load.image('three', './img/three.png');
            game.load.image('one', './img/one.png');
            game.load.audio('bgMusic', './audio/bgm.mp3');
            progressFn(game);
        }
    },
    created: function() {
        this.create = function() {
            // æ·»åŠ èƒŒæ™¯
            let bg = game.add.image(0, 0, 'bg');
            bg.width = game.world.width;
            bg.height = game.world.height;
            // æ·»åŠ æ ‡é¢˜
            const title = game.add.text(game.world.centerX, game.world.centerY * 0.25, 'å°æé¾™æ¥è‹¹æœ', {
                fontSize: '40px',
                fontWeight: 'blod',
                fill: '#f2bb15',
            });
            title.anchor.setTo(0.5, 0.5);
            // æ·»åŠ æç¤º
            const remind = game.add.text(game.world.centerX, game.world.centerY * 0.5, 'ç‚¹å‡»ä»»æ„ä½ç½®å¼€å§‹', {
                fontSize: '20px',
                fill: '#f2bb15'
            });
            remind.anchor.setTo(0.5, 0.5);
            // æ·»åŠ ä¸»è§’
            const man = game.add.sprite(game.world.centerX, game.world.height * 0.75, 'dude');
            const manImage = game.cache.getImage('dude');
            man.width = game.world.width * 0.2;
            man.height = man.width / manImage.width * manImage.height;
            man.anchor.setTo(0.5, 0.5);
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            game.input.onTap.add(() => {
                game.state.start('play');
            });
        };
    },
    play: function() {
        let title;
        let man;
        let apples;
        let score = 0;
        this.create = function() {
			// æ·»åŠ èƒŒæ™¯
            var bg = game.add.image(0, 0, 'bg');
            bg.width = game.world.width;
            bg.height = game.world.height;
            // æ·»åŠ ä¸»è§’
            man = game.add.sprite(game.world.centerX, game.world.height * 0.75, 'dude');
            var manImage = game.cache.getImage('dude');
            man.width = game.world.width * 0.2;
            man.height = man.width / manImage.width * manImage.height;
            man.anchor.setTo(0.5, 0.5);
            game.physics.enable(man); // åŠ å…¥ç‰©ç†è¿åŠ¨
            man.body.allowGravity = false; // æ¸…é™¤é‡åŠ›å½±å“
            // æ·»åŠ åˆ†æ•°
            title = game.add.text(game.world.centerX, game.world.height * 0.25, score, {
                fontSize: '80px',
                fontWeight: 'bold',
                fill: '#f2bb15'
            });
            title.anchor.setTo(0.5, 0.5);
            // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            const bgMusic = game.add.audio('bgMusic');
            bgMusic.loopFull();
            const scoreMusic = game.add.audio('scoreMusic');
            const bombMusic = game.add.audio('bombMusic');
            // æ·»åŠ è‹¹æœ
            apples = game.add.group();
            const appleTypes = ['green', 'red', 'yellow', 'bomb'];
            const appleTime = game.time.create(true);
            appleTime.loop(500, () => {
                const x = Math.random() * game.world.width;
                const y = 0;
                const type = appleTypes[Math.floor(Math.random() * appleTypes.length)];
                // console.log(x, y, type);
                const apple = apples.create(x, y, type);
                // è®¾ç½®è‹¹æœåŠ å…¥ç‰©ç†è¿åŠ¨
                game.physics.enable(apple);
                // è®¾ç½®è‹¹æœå¤§å°
                const appleImg = game.cache.getImage(type);
                apple.width = game.world.width / 8;
                apple.height = apple.width / appleImg.width * appleImg.height;
                // æ‰è½ç‰©è®¾ç½®å’Œè¾¹ç•Œæ¥è§¦
                apple.body.collideWorldBounds = true;
                apple.body.onWorldBounds = new Phaser.Signal();
                apple.body.onWorldBounds.add(function(apple, up, down, left, right) {
                    if (down) {
                        apple.kill();
                        if (apple.key === 'bomb') return;
                        game.state.start('over', true, false, score);
                    }
                });
            });
            appleTime.start();
            // å¼€å¯ç‰©ç†å¼•æ“
            game.physics.startSystem(Phaser.Physics.Arcade);
            game.physics.arcade.gravity.y = 300;            
            // ç›‘å¬æ»‘åŠ¨äº‹ä»¶
            let touching = false;
            let dx;
            game.input.onDown.add((pointer) => {
                if (Math.abs(pointer.x - man.x) < man.width / 2) {
                    touching = true;
                    dx = man.x - pointer.x;
                }
            });
            game.input.onUp.add(() => {
                touching = false;
            });
            game.input.addMoveCallback((pointer, x ,y, isTap) => {
                // console.log(x, y);
                if (!isTap && touching) man.x = x + dx;
            });
        }
        this.update = function() {
            // æ£€æµ‹ä¸»è§’å’Œæ‰è½ç‰©çš„ç¢°æ’
            game.physics.arcade.overlap(man, apples, pickApple, null, this);
        }
        const pickApple = function(man, apple) {
            var point = 1;
            var img = 'one';
            if (apple.key === 'red') {
                point = 3;
                img = 'three';
            } else if (apple.key === 'yellow') {
                point = 5;
                img = 'five';
            } else if (apple.key === 'bomb') {
                game.state.start('over', true, false, score);
                return;
            }
            // æ·»åŠ å¾—åˆ†å›¾ç‰‡
            var goal = game.add.image(apple.x, apple.y, img);
            var goalImg = game.cache.getImage(img);
            goal.width = apple.width;
            goal.height = goal.width / (goalImg.width / goalImg.height);
            goal.alpha = 0;

            // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
            var showTween = game.add.tween(goal).to({
                alpha: 1,
                y: goal.y - 20
            }, 100, Phaser.Easing.Linear.None, true, 0, 0, false);
            showTween.onComplete.add(function() {
                var hideTween = game.add.tween(goal).to({
                    alpha: 0,
                    y: goal.y - 20
                }, 100, Phaser.Easing.Linear.None, true, 200, 0, false);
                hideTween.onComplete.add(function() {
                    goal.kill();
                });
            });
            
            title.text = +score + point;
            score = title.text;
            apple.kill();
        }
    },
    over: function() {
        let score = 0;
        this.init = function() {
            score = arguments[0];
        }
        this.create = function() {
            game.stage.backgroundColor = '#000';
            // æ·»åŠ æ–‡æœ¬
            const title = game.add.text(game.world.centerX, game.world.centerY * 0.25, 'æ¸¸æˆç»“æŸ',{
                fontSize: '40px',
                fontWeight: 'bold',
                fill: '#f2bb15'
            });
            title.anchor.setTo(0.5, 0.5);
            const scoreStr = 'ä½ çš„å¾—åˆ†æ˜¯ï¼š'+score+'åˆ†, è€å©†ä¹ˆä¹ˆå“’ğŸ˜˜';
            const scoreText = game.add.text(game.world.centerX, game.world.height * 0.4, scoreStr, {
                fontSize: '30px',
                fontWeight: 'bold',
                fill: '#f2bb15'
            });
            scoreText.anchor.setTo(0.5, 0.5);
            const remind = game.add.text(game.world.centerX, game.world.height * 0.6, 'ç‚¹å‡»ä»»æ„ä½ç½®å†ç©ä¸€æ¬¡', {
                fontSize: '20px',
                fontWeight: 'bold',
                fill: '#f2bb15'
            });
            remind.anchor.setTo(0.5, 0.5);
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            game.input.onTap.add(function() {
                game.state.start('play');
            });
        }
    },
};


Object.keys(states).map(function(key) {
	game.state.add(key, states[key]);
});

// å¯åŠ¨æ¸¸æˆ
game.state.start('preload');




</script>

</body>
</html>